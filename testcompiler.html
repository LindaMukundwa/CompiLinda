<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CompiLinda Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        pre { background-color: #f5f5f5; padding: 10px; border-radius: 5px; }
        button { padding: 10px 15px; margin: 10px 0; cursor: pointer; }
        .output { margin-top: 20px; border: 1px solid #ddd; padding: 10px; }
    </style>
</head>
<body>
    <h1>CompiLinda Compiler Test</h1>
    
    <textarea id="sourceCode" rows="8" cols="60" placeholder="Enter source code here (e.g., {}$)">{}$</textarea>
    <br>
    <button onclick="runTest()">Run Test</button>
    
    <div class="output">
        <h3>Console Output:</h3>
        <pre id="consoleOutput"></pre>
    </div>
    
    <script>
        // Function to log to our console output div
        function log(message, isError = false) {
            const output = document.getElementById('consoleOutput');
            const line = document.createElement('div');
            line.textContent = message;
            if (isError) {
                line.style.color = 'red';
            }
            output.appendChild(line);
            console.log(message);
        }
        
        // Function to clear our console output
        function clearLog() {
            document.getElementById('consoleOutput').innerHTML = '';
        }
        
        // Function to run the test
        function runTest() {
            clearLog();
            log("Starting test...");
            
            // Check if the window objects exist
            log("Checking for Lexer: " + (typeof window.Lexer !== 'undefined' ? "Found" : "Not found"));
            log("Checking for Parser: " + (typeof window.Parser !== 'undefined' ? "Found" : "Not found"));
            
            if (typeof window.Lexer === 'undefined' || typeof window.Parser === 'undefined') {
                log("ERROR: Components not loaded properly", true);
                return;
            }
            
            // Get the source code
            const sourceCode = document.getElementById('sourceCode').value;
            log(`Source code: "${sourceCode}"`);
            
            try {
                // Try lexer
                log("Creating Lexer instance...");
                const lexer = new window.Lexer(sourceCode);
                
                log("Running tokenize()...");
                const lexResult = lexer.tokenize();
                
                log("Lexer result:");
                log(JSON.stringify(lexResult, null, 2));
                
                // Check if we got tokens
                if (!lexResult.tokens || lexResult.tokens.length === 0) {
                    log("WARNING: No tokens produced", true);
                } else {
                    log(`Found ${lexResult.tokens.length} tokens`);
                    
                    // Try parser if we have tokens
                    log("Creating Parser instance...");
                    const parser = new window.Parser(lexResult.tokens);
                    
                    log("Running parse()...");
                    const parseResult = parser.parse();
                    
                    log("Parser result:");
                    log(JSON.stringify({
                        success: !!parseResult.ast,
                        logCount: parseResult.logs.length
                    }, null, 2));
                    
                    if (parseResult.ast) {
                        log("AST generated successfully");
                        log("Pretty printed CST:");
                        log(parser.printCST(parseResult.ast));
                    } else {
                        log("ERROR: No AST generated", true);
                    }
                }
            } catch (error) {
                log("ERROR: " + (error.message || error), true);
                log("Stack trace: " + (error.stack || "Not available"), true);
            }
            
            log("Test complete");
        }
    </script>
    
    <!-- Load the scripts with proper error handling -->
    <script>
        function loadScript(url, callback) {
            var script = document.createElement('script');
            script.type = 'text/javascript';
            
            if (script.readyState) {  // IE
                script.onreadystatechange = function() {
                    if (script.readyState === 'loaded' || script.readyState === 'complete') {
                        script.onreadystatechange = null;
                        callback();
                    }
                };
            } else {  // Others
                script.onload = function() {
                    callback();
                };
            }
            
            script.onerror = function() {
                log(`ERROR: Failed to load script: ${url}`, true);
            };
            
            script.src = url;
            document.body.appendChild(script);
        }
        
        // First define exports object
        var exports = {};
        
        // Load main.js first
        log("Loading main.js...");
        loadScript('./dist/main.js', function() {
            log("main.js loaded");
            
            // Then load parser.js
            log("Loading parser.js...");
            loadScript('./dist/parser.js', function() {
                log("parser.js loaded");
                log("Setup complete - you can now run the test");
            });
        });
    </script>
</body>
</html>